@model BookwormsOnline.ViewModels.ChangeCredentials

<h1>Edit Profile</h1>

@using (Html.BeginForm("ChangeCredentials", "Manage", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()

    <div class="form-group">
        @Html.LabelFor(m => m.FirstName)
        @Html.TextBoxFor(m => m.FirstName, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.FirstName)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.LastName)
        @Html.TextBoxFor(m => m.LastName, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.LastName)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.MobileNo)
        @Html.TextBoxFor(m => m.MobileNo, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.MobileNo)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.BillingAddress)
        @Html.TextAreaFor(m => m.BillingAddress, new { @class = "form-control", rows = 3 })
        @Html.ValidationMessageFor(m => m.BillingAddress)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.ShippingAddress)
        @Html.TextAreaFor(m => m.ShippingAddress, new { @class = "form-control", rows = 3 })
        @Html.ValidationMessageFor(m => m.ShippingAddress)
    </div>

    <div class="form-group">
        <label>Current profile photo</label>
        @if (!string.IsNullOrEmpty(Model.OriginalPhotoURL))
        {
            <div>
                <img src="@Model.OriginalPhotoURL" alt="Current Photo" class="img-fluid rounded-circle" style="width: 200px; height: 200px; object-fit: cover; border: 1px solid #ddd; padding: 5px;" />
            </div>
        }
        else
        {
            <div>No profile photo set.</div>
        }

        <label class="mt-2">Upload new photo (JPG only, leave blank to keep current)</label>
        <input type="file" name="PhotoFile" accept=".jpg,.jpeg" class="form-control" id="photoFileInput" />
        @Html.ValidationMessageFor(m => m.PhotoFile)

        @Html.HiddenFor(m => m.OriginalPhotoURL)
        @Html.HiddenFor(m => m.Revert)

        <div class="mt-2">
            <button type="button" class="btn btn-warning" id="revertBtn">Revert to original</button>
        </div>
    </div>

    <script>
        (function(){
            const fileInput = document.getElementById('photoFileInput');
            const maxBytes = 2 * 1024 * 1024; // 2MB
            fileInput?.addEventListener('change', function(e){
                const f = this.files[0];
                if (!f) return;
                const allowed = ['image/jpeg','image/jpg'];
                if (!allowed.includes(f.type)){
                    alert('Only JPG images are allowed.');
                    this.value = '';
                    return;
                }
                if (f.size > maxBytes){
                    alert('File size must be 2MB or less.');
                    this.value = '';
                    return;
                }
            });

            document.getElementById('revertBtn')?.addEventListener('click', function(e){
                e.preventDefault();
                e.stopPropagation();
                // Clear the file input and reload the page to show original photo
                document.getElementById('photoFileInput').value = '';
                // Reload page to show original without saving
                window.location.reload();
            });
        })();
    </script>

    <button type="submit" class="btn btn-primary">Save changes</button>
    <a class="btn btn-link" asp-controller="Manage" asp-action="Index">Cancel</a>
}
