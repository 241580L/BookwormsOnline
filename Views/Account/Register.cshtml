@model BookwormsOnline.ViewModels.Register
@inject Microsoft.Extensions.Options.IOptions<BookwormsOnline.Services.ReCaptchaSettings> RecaptchaOptions

@{
    ViewData["Title"] = "Register";
    var siteKey = RecaptchaOptions?.Value?.SiteKey ?? "";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Register" asp-controller="Account" method="post" enctype="multipart/form-data" id="registerForm" novalidate>
    <div asp-validation-summary="All" class="text-danger"></div>
    <div class="form-group">
        <label asp-for="FirstName"></label>
        <input asp-for="FirstName" class="form-control" maxlength="50" />
        <small class="form-text text-muted">Maximum 50 characters</small>
        <span asp-validation-for="FirstName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="LastName"></label>
        <input asp-for="LastName" class="form-control" maxlength="50" />
        <small class="form-text text-muted">Maximum 50 characters</small>
        <span asp-validation-for="LastName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="CreditCardNo"></label>
        <input asp-for="CreditCardNo" class="form-control" inputmode="numeric" maxlength="19" />
        <small class="form-text text-muted">Credit card is stored encrypted server-side. 13-19 digits.</small>
        <span asp-validation-for="CreditCardNo" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="MobileNo"></label>
        <input asp-for="MobileNo" class="form-control" maxlength="20" />
        <small class="form-text text-muted">Maximum 20 characters. Encrypted server-side.</small>
        <span asp-validation-for="MobileNo" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="BillingAddress"></label>
        <input asp-for="BillingAddress" class="form-control" maxlength="200" />
        <small class="form-text text-muted">Maximum 200 characters. Encrypted server-side.</small>
        <span asp-validation-for="BillingAddress" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="ShippingAddress"></label>
        <textarea asp-for="ShippingAddress" class="form-control" maxlength="200"></textarea>
        <small class="form-text text-muted">Maximum 200 characters. Encrypted server-side.</small>
        <span asp-validation-for="ShippingAddress" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Email"></label>
        <input asp-for="Email" class="form-control" maxlength="100" />
        <small class="form-text text-muted">Maximum 100 characters. Encrypted server-side.</small>
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Password"></label>
        <input asp-for="Password" id="password" class="form-control" autocomplete="new-password" />
        <span asp-validation-for="Password" class="text-danger"></span>
        <small class="form-text text-muted">Password must be at least 12 characters long and contain uppercase letters, lowercase letters, numbers, and special characters.</small>
        <div class="mt-2">
            <div class="progress" style="height:8px;">
                <div id="pwStrengthBar" class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>
            <small id="pwStrengthText" class="form-text text-muted"></small>
        </div>
    </div>

    <div class="form-group">
        <label asp-for="ConfirmPassword"></label>
        <input asp-for="ConfirmPassword" class="form-control" autocomplete="new-password" />
        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Photo">Photo (.JPG only)</label>
        <input asp-for="Photo" type="file" accept=".jpg,image/jpeg" class="form-control-file" id="photoInput" />
        <span asp-validation-for="Photo" class="text-danger"></span>
    </div>

    <!-- Google reCAPTCHA v3 - Token handled via JavaScript -->
    <input type="hidden" id="recaptcha_token" name="recaptcha_token" />

    <button type="submit" id="registerBtn" class="btn btn-primary mt-3">Register</button>
</form>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    @* Include unobtrusive validation scripts *@
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        // Add custom creditcard validator for jQuery Validate
        $.validator.addMethod("creditcard", function(value, element) {
            if (!value) return true; // Allow empty for required rule to handle
            
            // Remove spaces and dashes
            value = value.replace(/[\s-]/g, '');
            
            // Must be 13-19 digits
            if (!/^\d{13,19}$/.test(value)) {
                return false;
            }
            
            // Luhn algorithm validation
            var sum = 0;
            var isEven = false;
            
            for (var i = value.length - 1; i >= 0; i--) {
                var digit = parseInt(value.charAt(i), 10);
                
                if (isEven) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9;
                    }
                }
                
                sum += digit;
                isEven = !isEven;
            }
            
            return (sum % 10) === 0;
        }, "Please enter a valid credit card number.");
    </script>

    <script>
        (function () {
            var password = document.getElementById('password');
            var strengthBar = document.getElementById('pwStrengthBar');
            var strengthText = document.getElementById('pwStrengthText');
            var registerBtn = document.getElementById('registerBtn');
            var form = document.getElementById('registerForm');

            // Configuration for field length validation
            var fieldLimits = {
                'FirstName': { max: 50, min: 1, warning: 'First name' },
                'LastName': { max: 50, min: 1, warning: 'Last name' },
                'CreditCardNo': { max: 19, min: 13, warning: 'Credit card number' },
                'MobileNo': { max: 20, min: 7, warning: 'Mobile number' },
                'BillingAddress': { max: 200, min: 5, warning: 'Billing address' },
                'ShippingAddress': { max: 200, min: 5, warning: 'Shipping address' },
                'Email': { max: 100, min: 5, warning: 'Email address' }
            };

            // Add real-time length validation for each field
            Object.keys(fieldLimits).forEach(function(fieldId) {
                var field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        var limit = fieldLimits[fieldId];
                        var length = this.value.length;
                        
                        // Update visual feedback
                        if (length > limit.max) {
                            this.classList.add('is-invalid');
                            this.classList.remove('is-valid');
                        } else if (length >= limit.min) {
                            this.classList.add('is-valid');
                            this.classList.remove('is-invalid');
                        } else {
                            this.classList.remove('is-valid');
                            this.classList.remove('is-invalid');
                        }
                    });

                    // Prevent exceeding max length (client-side enforcement)
                    field.addEventListener('keypress', function(e) {
                        var limit = fieldLimits[fieldId];
                        if (this.value.length >= limit.max) {
                            e.preventDefault();
                            console.warn(limit.warning + ' has reached maximum length of ' + limit.max + ' characters');
                        }
                    });
                }
            });

            function updateStrength() {
                var val = password.value || '';
                var result = zxcvbn(val);
                var score = result.score; // 0 - 4
                console.log(score);
                var pct = (score / 4) * 100;
                strengthBar.style.width = pct + '%';
                strengthBar.className = 'progress-bar';
                if (score <= 1) {
                    strengthBar.classList.add('bg-danger');
                    strengthText.textContent = 'Weak';
                } else if (score == 2) {
                    strengthBar.classList.add('bg-warning');
                    strengthText.textContent = 'Fair';
                } else if (score == 3) {
                    strengthBar.classList.add('bg-info');
                    strengthText.textContent = 'Good';
                } else {
                    strengthBar.classList.add('bg-success');
                    strengthText.textContent = 'Strong';
                }
            }

            password.addEventListener('input', function () {
                updateStrength();
            });

            // Client-side enforcement: validate all fields before submission
            async function submitFormWithRecaptcha() {
                // Validate length constraints for all sensitive fields
                for (var fieldId in fieldLimits) {
                    var field = document.getElementById(fieldId);
                    if (field) {
                        var limit = fieldLimits[fieldId];
                        var length = field.value.length;

                        if (length === 0 && fieldId !== 'Photo') {
                            alert(limit.warning + ' is required');
                            field.focus();
                            return false;
                        }

                        if (length > limit.max) {
                            alert(limit.warning + ' must not exceed ' + limit.max + ' characters. Current length: ' + length);
                            field.focus();
                            return false;
                        }

                        if (length > 0 && length < limit.min) {
                            alert(limit.warning + ' must be at least ' + limit.min + ' characters');
                            field.focus();
                            return false;
                        }
                    }
                }

                // Validate password strength
                var val = password.value || '';
                var res = zxcvbn(val);
                if (res.score < 3) {
                    alert('Please choose a stronger password (min. 12 chars, mix of upper/lower, numbers and symbols).');
                    password.focus();
                    return false;
                }

                // Check if reCAPTCHA has been loaded
                if (typeof grecaptcha === 'undefined') {
                    alert('reCAPTCHA is still loading. Please try again.');
                    return false;
                }
                
                try {
                    // For reCAPTCHA v3, execute and get the token asynchronously
                    var recaptchaToken = await grecaptcha.execute('@siteKey', { action: 'register' });
                    
                    // Set the hidden token field
                    document.getElementById('recaptcha_token').value = recaptchaToken;
                    form.submit();
                } catch (error) {
                    console.error('reCAPTCHA error:', error);
                    alert('An error occurred with reCAPTCHA. Please try again.');
                    return false;
                }
            }

            registerBtn.addEventListener('click', function (e) {
                e.preventDefault();
                submitFormWithRecaptcha();
            });
        })();
    </script>
}
